<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>ECIS 2018</title>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link rel="stylesheet" href="/css/style.css">

    <script defer src="https://use.fontawesome.com/releases/v5.0.6/js/all.js"></script>
</head>
<body>
    <div id="wrapper">

        <div id="timer" style="opacity:0;">
            <span class="hours"></span>:<span class="minutes"></span>:<span class="seconds"></span>
        </div>

        <div class="container-fluid main-container">

            <div class="row main-container-row">

                <div id="sidebar" class="col-1 d-flex flex-column justify-content-between">

                    <img src="/img/ecis-reverse-logo.png">

                    <a id="return-to-index" class="btn btn-light" href="/">
                        <i class="fa fa-cog fa-2x"></i>
                    </a>

                </div>

                <div id="page-content" class="col-11">

                    <h1 class="page-title">
                        Directions
                    </h1>

                    <div class="row">

                        <div class="col-12 col-md-4">

                            <div class="map-card text-center">

                                <p>
                                    <strong>From:</strong>
                                </p>

                                <p>
                                    <select id="start" class="custom-select">
                                        <option>My location</option>
                                        <option>Richmond Building, Southsea</option>
                                        <option>James Watson Hall, Southsea</option>
                                        <option>Portland Building, Southsea</option>
                                        <option></option>
                                        <option>Some place</option>
                                        <option>Some other place</option>
                                    </select>
                                </p>

                                <p>
                                    <strong>To:</strong>
                                </p>

                                <p>
                                    <select id="end" class="custom-select">
                                        <option>My location</option>
                                        <option>Richmond Building, Southsea</option>
                                        <option>James Watson Hall, Southsea</option>
                                        <option>Portland Building, Southsea</option>
                                        <option>Some other place</option>
                                        <option>Some place</option>
                                        <option>Some other place</option>
                                    </select>
                                </p>

                                <!-- <p>
                                    <a href="#" class="btn btn-primary">
                                        Show On Map
                                    </a>
                                </p> -->

                                <p>
                                    <a href="/email" class="btn btn-warning">
                                        Sent To Email <i class="fa fa-paper-plane"></i>
                                    </a>
                                </p>

                            </div>

                            <div class="map-card text-center">
                                <img src="https://api.qrserver.com/v1/create-qr-code/?data=HelloWorld&amp;size=200x200">
                            </div>

                        </div>

                        <div class="col-12 col-md-8 center-flex">
                            <div id="map"></div>
                        </div>

                    </div>

                </div>

            </div>

        </div>

    </div> <!-- /#wrapper -->
    <!-- END BODY CONTENT -->
    <!-- JS -->
    <script>
        // Get current location of the walk up system
        // These lets are global so we can access the location in another function
        let myLocationLat, myLocationLng
        function getCurrentLocation() {
            navigator.geolocation.getCurrentPosition((position) => {
                myLocationLat = position.coords.latitude
                myLocationLng = position.coords.longitude
                const currentLocation = {lat: myLocationLat, lng: myLocationLng}
                initMap(currentLocation)
            })
        }

        // Initialise map
    function initMap(currentLocation) {
        let directionsService = new google.maps.DirectionsService();
        let directionsDisplay = new google.maps.DirectionsRenderer();
        const mapOptions = {
          zoom: 13,
          center: currentLocation
        }
        const destinationCoords = JSON.parse(localStorage.getItem('coords')) || []
        const destinationCoordsObj = destinationCoords[0]
        let destination
        if(!destinationCoordsObj) {
            destination = {
                lat: 0,
                lng: 0
            }
        } else {
            destination = {
                lat: Number(destinationCoordsObj['lat']),
                lng: Number(destinationCoordsObj['lng'])
            }
        }
        console.log(destination);
        const map = new google.maps.Map(document.getElementById('map'), mapOptions);
        directionsDisplay.setMap(map);
        const request = {
            origin: currentLocation,
            destination,
            travelMode: 'DRIVING'
        }
        directionsService.route(request, function(result, status) {
            if (status == 'OK') {
                directionsDisplay.setDirections(result);
            }
        });

        // Nice way to pass in directionsService and directionsDisplay to another function via event listener
        var onChangeHandler = function() {
          calculateAndDisplayRoute(directionsService, directionsDisplay);
        };
        document.getElementById('start').addEventListener('change', onChangeHandler);
        document.getElementById('end').addEventListener('change', onChangeHandler);
    }

        // Update route once a new dropdown option is selected
    function calculateAndDisplayRoute(directionsService, directionsDisplay) {
        let start = document.getElementById('start').value
        let end = document.getElementById('end').value
        if(start === 'My location') {
           start = {lat: myLocationLat, lng: myLocationLng}
        }
        if(end === 'My location') {
           end = {lat: myLocationLat, lng: myLocationLng}
        }
        const request = {
            origin: start,
            destination: end,
            travelMode: 'DRIVING'
        };
        directionsService.route(request, function(result, status) {
            if (status == 'OK') {
                directionsDisplay.setDirections(result);
            }
        });
    }

    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?AIzaSyB5vpnssWpC_uebey4SPt61zMQbkrb4DRQ&callback=getCurrentLocation"></script>
    <script src="http://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
    <script src="/js/ecis.js"></script>
</body>
</html>
